name: Smoke Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: Install ChromeDriver
      run: |
        # Get Chrome version
        CHROME_VERSION=$(google-chrome --version | sed -E 's/.* ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
        echo "Chrome version: $CHROME_VERSION"
        
        # Validate Chrome version was extracted
        if [ -z "$CHROME_VERSION" ]; then
          echo "Error: Failed to extract Chrome version"
          exit 1
        fi
        
        # Extract major version
        MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
        
        # Get matching ChromeDriver version using Chrome for Testing JSON API
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${MAJOR_VERSION}")
        echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
        
        # Validate ChromeDriver version was retrieved
        if [ -z "$CHROMEDRIVER_VERSION" ]; then
          echo "Error: Failed to retrieve ChromeDriver version"
          exit 1
        fi
        
        # Download and install ChromeDriver
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
        unzip -q chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        chromedriver --version
    
    - name: Run test suite
      run: python test_features.py
    
    - name: Test helper scripts
      run: |
        # Test helper scripts individually
        python src/helper1.py
        python src/helper2.py
        python src/default_script.py
    
    - name: Create data directory
      run: mkdir -p data
    
    - name: Test helper scripts integration
      env:
        TEST_HELPERS: "1"
        TARGET_URL: https://example.com
        CACHE_DIR: ./data
        PYTHONPATH: ./src
      run: python smoke_test.py
    
    - name: Run smoke test
      env:
        TARGET_URL: https://example.com
        CACHE_DIR: ./data
      run: python smoke_test.py
    
    - name: Upload smoke test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-results
        path: data/
        retention-days: 7
